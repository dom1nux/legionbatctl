#!/bin/bash

# System file paths
CONS_MODE="/sys/bus/platform/drivers/ideapad_acpi/VPC2004:00/conservation_mode"
CONFIG_FILE="/etc/legionbatctl.conf"

# Default values
DEFAULT_ENABLED=1
DEFAULT_THRESHOLD=80

# Function to check if we have root permissions
check_root() {
    if [ "$EUID" -ne 0 ]; then
        echo "This script requires root privileges"
        exit 1
    fi
}

# Function to ensure config file exists with default values
ensure_config() {
    if [ ! -f "$CONFIG_FILE" ]; then
        cat > "$CONFIG_FILE" << EOF
CONSERVATION_ENABLED=$DEFAULT_ENABLED
CHARGE_THRESHOLD=$DEFAULT_THRESHOLD
EOF
        chmod 644 "$CONFIG_FILE"
    fi
}

# Function to read configuration values
read_config() {
    if [ -f "$CONFIG_FILE" ]; then
        # Source the config file to get values
        . "$CONFIG_FILE"
        # Set defaults if values are missing
        CONSERVATION_ENABLED=${CONSERVATION_ENABLED:-$DEFAULT_ENABLED}
        CHARGE_THRESHOLD=${CHARGE_THRESHOLD:-$DEFAULT_THRESHOLD}
    else
        CONSERVATION_ENABLED=$DEFAULT_ENABLED
        CHARGE_THRESHOLD=$DEFAULT_THRESHOLD
    fi
}

# Function to update configuration value
update_config() {
    local key=$1
    local value=$2
    
    # Read current config
    if [ -f "$CONFIG_FILE" ]; then
        # Create temp file
        tmp_file=$(mktemp)
        while IFS= read -r line || [[ -n "$line" ]]; do
            if [[ $line =~ ^$key= ]]; then
                echo "$key=$value" >> "$tmp_file"
            else
                echo "$line" >> "$tmp_file"
            fi
        done < "$CONFIG_FILE"
        mv "$tmp_file" "$CONFIG_FILE"
        chmod 644 "$CONFIG_FILE"
    else
        ensure_config
    fi
}

# Function to get current conservation mode status
get_status() {
    if [ -f "$CONS_MODE" ]; then
        read_config
        cons_status=$(cat "$CONS_MODE")
        
        echo "Hardware conservation mode: $([ "$cons_status" -eq 1 ] && echo "enabled" || echo "disabled")"
        echo "Battery management: $([ "$CONSERVATION_ENABLED" -eq 1 ] && echo "enabled" || echo "disabled")"
        echo "Charge threshold: ${CHARGE_THRESHOLD}%"
    else
        echo "Error: Conservation mode control file not found"
        exit 1
    fi
}

# Function to toggle conservation mode and battery management
toggle_mode() {
    if [ -f "$CONS_MODE" ]; then
        read_config
        if [ "$CONSERVATION_ENABLED" -eq 1 ]; then
            update_config "CONSERVATION_ENABLED" 0
            echo 0 > "$CONS_MODE"
            echo "Battery management disabled (will charge to 100%)"
        else
            update_config "CONSERVATION_ENABLED" 1
            echo "Battery management enabled (will maintain ${CHARGE_THRESHOLD}% limit)"
        fi
    else
        echo "Error: Conservation mode control file not found"
        exit 1
    fi
}

# Function to enable conservation mode and battery management
enable_mode() {
    if [ -f "$CONS_MODE" ]; then
        read_config
        update_config "CONSERVATION_ENABLED" 1
        echo "Battery management enabled (will maintain ${CHARGE_THRESHOLD}% limit)"
    else
        echo "Error: Conservation mode control file not found"
        exit 1
    fi
}

# Function to disable conservation mode and battery management
disable_mode() {
    if [ -f "$CONS_MODE" ]; then
        update_config "CONSERVATION_ENABLED" 0
        echo 0 > "$CONS_MODE"
        echo "Battery management disabled (will charge to 100%)"
    else
        echo "Error: Conservation mode control file not found"
        exit 1
    fi
}

# Function to set charge threshold
set_threshold() {
    local threshold=$1
    
    # Validate threshold value
    if ! [[ "$threshold" =~ ^[0-9]+$ ]] || [ "$threshold" -lt 20 ] || [ "$threshold" -gt 100 ]; then
        echo "Error: Threshold must be a number between 20 and 100"
        exit 1
    fi
    
    update_config "CHARGE_THRESHOLD" "$threshold"
    echo "Charge threshold set to ${threshold}%"
}

# Main script
check_root
ensure_config

case "$1" in
    "status")
        get_status
        ;;
    "toggle")
        toggle_mode
        ;;
    "enable")
        enable_mode
        ;;
    "disable")
        disable_mode
        ;;
    "set-threshold")
        if [ -z "$2" ]; then
            echo "Error: Threshold value required"
            echo "Usage: batteryctl set-threshold <percentage>"
            exit 1
        fi
        set_threshold "$2"
        ;;
    *)
        echo "Usage: batteryctl {status|toggle|enable|disable|set-threshold <percentage>}"
        echo
        echo "Commands:"
        echo "  status        - Show current battery management and conservation mode status"
        echo "  toggle        - Toggle between threshold limit and 100% charging"
        echo "  enable        - Enable battery management (limit to configured threshold)"
        echo "  disable       - Disable battery management (allow charging to 100%)"
        echo "  set-threshold - Set battery charge threshold (20-100)"
        exit 1
        ;;
esac