#!/bin/bash

# System file paths
BATTERY="/sys/class/power_supply/BAT0/capacity"
CONS_MODE="/sys/bus/platform/drivers/ideapad_acpi/VPC2004:00/conservation_mode"
CONFIG_FILE="/etc/legionbatctl.conf"

# Check if we have root permissions
if [ "$EUID" -ne 0 ]; then
    echo "Error: This script requires root privileges"
    exit 1
fi

# Check if required files exist
for file in "$BATTERY" "$CONS_MODE" "$CONFIG_FILE"; do
    if [ ! -f "$file" ]; then
        echo "Error: Required file not found: $file"
        exit 1
    fi
done

# Read configuration
. "$CONFIG_FILE"

# Get current battery level
battery_level=$(cat "$BATTERY")

# Only proceed if battery management is enabled
if [ "${CONSERVATION_ENABLED:-1}" -eq 1 ]; then
    if [ "$battery_level" -ge "${CHARGE_THRESHOLD:-80}" ]; then
        # Enable conservation mode to stop charging
        echo 1 > "$CONS_MODE"
    elif [ "$battery_level" -lt "${CHARGE_THRESHOLD:-80}" ]; then
        # Disable conservation mode to allow charging
        echo 0 > "$CONS_MODE"
    fi
fi